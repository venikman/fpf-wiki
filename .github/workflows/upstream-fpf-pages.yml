name: Publish upstream FPF snapshot

on:
  repository_dispatch:
    types:
      - ailev-fpf-main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout wiki
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Fetch latest ailev/FPF main commit
        id: upstream
        run: |
          bun -e "
            import { appendFileSync } from 'node:fs';
            import { env } from 'bun';

            const url = 'https://api.github.com/repos/ailev/FPF/commits/main';
            const headers = {
              'User-Agent': 'venikman-fpf-wiki',
              Accept: 'application/vnd.github+json',
            };

            if (env.GITHUB_TOKEN) {
              headers.Authorization = `Bearer ${env.GITHUB_TOKEN}`;
            }

            const fail = (message) => {
              console.error(message);
              process.exit(1);
            };

            let data;
            try {
              const resp = await fetch(url, { headers });
              const detail = await resp.text();
              if (!resp.ok) {
                fail(`::error::Failed to fetch upstream commit (status ${resp.status}): ${detail}`);
              }
              try {
                data = JSON.parse(detail);
              } catch (error) {
                fail(`::error::Failed to parse upstream commit response: ${error}`);
              }
            } catch (error) {
              fail(`::error::Failed to fetch upstream commit (network): ${error}`);
            }

            const sha = data?.sha ?? '';
            const commit = data?.commit ?? {};
            const authorInfo = commit.author ?? {};

            const message = commit.message ?? '';
            const author = authorInfo.name ?? '';
            const date = authorInfo.date ?? '';
            const htmlUrl = data?.html_url ?? '';
            const fetchedAt = new Date().toISOString();

            const delimiter = 'EOF_COMMIT_MESSAGE';
            const lines = [
              `sha=${sha}`,
              `author=${author}`,
              `date=${date}`,
              `html_url=${htmlUrl}`,
              `fetched_at=${fetchedAt}`,
              `message<<${delimiter}`,
              message.endsWith('\\n') ? message : `${message}\\n`,
              delimiter,
            ];

            appendFileSync(env.GITHUB_OUTPUT, lines.join('\\n'), 'utf8');
          "
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Build static snapshot page
        run: |
          bun -e "
            import { mkdirSync, writeFileSync } from 'node:fs';
            import { join } from 'node:path';
            import { env } from 'bun';

            const site = 'site';
            mkdirSync(site, { recursive: true });

            const {
              SHA,
              MESSAGE,
              AUTHOR = '',
              DATE = '',
              HTML_URL = '',
              FETCHED_AT = '',
              TRIGGER = 'unknown',
            } = env;

            const escapeHtml = (value = '') =>
              String(value).replace(/[&<>'\"]/g, (char) => {
                switch (char) {
                  case '&':
                    return '&amp;';
                  case '<':
                    return '&lt;';
                  case '>':
                    return '&gt;';
                  case '\"':
                    return '&quot;';
                  case \"'\":
                    return '&#x27;';
                  default:
                    return char;
                }
              });

            const content = `<!doctype html>
          <html lang=\"en\">
          <head>
            <meta charset=\"utf-8\">
            <title>FPF upstream snapshot</title>
            <style>
              body { font-family: system-ui, -apple-system, sans-serif; max-width: 760px; margin: 2rem auto; padding: 0 1rem; line-height: 1.6; }
              code { background: #f4f4f4; padding: 0.15rem 0.35rem; border-radius: 4px; }
              pre { background: #f4f4f4; padding: 1rem; border-radius: 6px; white-space: pre-wrap; }
              .meta { color: #444; }
            </style>
          </head>
          <body>
            <h1>Latest ailev/FPF main commit</h1>
            <p class=\"meta\">Generated at ${escapeHtml(FETCHED_AT)} via ${escapeHtml(TRIGGER)}.</p>
            <ul>
              <li><strong>SHA:</strong> <code>${escapeHtml(SHA)}</code></li>
              <li><strong>Author:</strong> ${escapeHtml(AUTHOR)}</li>
              <li><strong>Date:</strong> ${escapeHtml(DATE)}</li>
              <li><strong>Commit:</strong> <a href=\"${escapeHtml(HTML_URL)}\">${escapeHtml(HTML_URL)}</a></li>
            </ul>
            <h2>Message</h2>
            <pre>${escapeHtml(MESSAGE)}</pre>
          </body>
          </html>`;

            writeFileSync(join(site, 'index.html'), content, 'utf8');
          "
        env:
          SHA: ${{ steps.upstream.outputs.sha }}
          MESSAGE: ${{ steps.upstream.outputs.message }}
          AUTHOR: ${{ steps.upstream.outputs.author }}
          DATE: ${{ steps.upstream.outputs.date }}
          HTML_URL: ${{ steps.upstream.outputs.html_url }}
          FETCHED_AT: ${{ steps.upstream.outputs.fetched_at }}
          TRIGGER: ${{ github.event_name }}

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
