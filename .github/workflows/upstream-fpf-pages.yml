name: Publish upstream FPF snapshot

on:
  repository_dispatch:
    types:
      - ailev-fpf-main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout wiki
        uses: actions/checkout@v4

      - name: Fetch latest ailev/FPF main commit
        id: upstream
        run: |
          python - <<'PY'
          import datetime, json, os, sys, urllib.request, urllib.error

          url = "https://api.github.com/repos/ailev/FPF/commits/main"
          headers = {
            "User-Agent": "venikman-fpf-wiki",
            "Accept": "application/vnd.github+json",
          }
          token = os.getenv("GITHUB_TOKEN")
          if token:
            headers["Authorization"] = f"Bearer {token}"

          try:
            req = urllib.request.Request(url, headers=headers)
            with urllib.request.urlopen(req) as resp:
              data = json.load(resp)
          except urllib.error.HTTPError as exc:
            detail = exc.read().decode("utf-8", "ignore")
            print(f"::error::Failed to fetch upstream commit (status {exc.code}): {detail}")
            sys.exit(1)
          except Exception as exc:
            print(f"::error::Failed to fetch upstream commit (network/parse): {exc}")
            sys.exit(1)

          sha = data.get("sha", "")
          commit = data.get("commit", {})
          author_info = commit.get("author", {})

          message = commit.get("message", "")
          author = author_info.get("name", "")
          date = author_info.get("date", "")
          html_url = data.get("html_url", "")
          fetched_at = datetime.datetime.now(datetime.timezone.utc).isoformat()

          delimiter = "EOF_COMMIT_MESSAGE"
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"sha={sha}\n")
            f.write(f"author={author}\n")
            f.write(f"date={date}\n")
            f.write(f"html_url={html_url}\n")
            f.write(f"fetched_at={fetched_at}\n")
            f.write(f"message<<{delimiter}\n")
            f.write(message + ("" if message.endswith("\n") else "\n"))
            f.write(f"{delimiter}\n")
          PY
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Build static snapshot page
        run: |
          python - <<'PY'
          import html, os, pathlib

          site = pathlib.Path("site")
          site.mkdir(parents=True, exist_ok=True)

          sha = os.environ["SHA"]
          message = os.environ["MESSAGE"]
          author = os.environ.get("AUTHOR", "")
          date = os.environ.get("DATE", "")
          html_url = os.environ.get("HTML_URL", "")
          fetched_at = os.environ.get("FETCHED_AT", "")
          trigger = os.environ.get("TRIGGER", "unknown")

          content = f"""<!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <title>FPF upstream snapshot</title>
            <style>
              body {{ font-family: system-ui, -apple-system, sans-serif; max-width: 760px; margin: 2rem auto; padding: 0 1rem; line-height: 1.6; }}
              code {{ background: #f4f4f4; padding: 0.15rem 0.35rem; border-radius: 4px; }}
              pre {{ background: #f4f4f4; padding: 1rem; border-radius: 6px; white-space: pre-wrap; }}
              .meta {{ color: #444; }}
            </style>
          </head>
          <body>
            <h1>Latest ailev/FPF main commit</h1>
            <p class="meta">Generated at {html.escape(fetched_at)} via {html.escape(trigger)}.</p>
            <ul>
              <li><strong>SHA:</strong> <code>{html.escape(sha)}</code></li>
              <li><strong>Author:</strong> {html.escape(author)}</li>
              <li><strong>Date:</strong> {html.escape(date)}</li>
              <li><strong>Commit:</strong> <a href="{html.escape(html_url)}">{html.escape(html_url)}</a></li>
            </ul>
            <h2>Message</h2>
            <pre>{html.escape(message)}</pre>
          </body>
          </html>
          """

          (site / "index.html").write_text(content, encoding="utf-8")
          PY
        env:
          SHA: ${{ steps.upstream.outputs.sha }}
          MESSAGE: ${{ steps.upstream.outputs.message }}
          AUTHOR: ${{ steps.upstream.outputs.author }}
          DATE: ${{ steps.upstream.outputs.date }}
          HTML_URL: ${{ steps.upstream.outputs.html_url }}
          FETCHED_AT: ${{ steps.upstream.outputs.fetched_at }}
          TRIGGER: ${{ github.event_name }}

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
