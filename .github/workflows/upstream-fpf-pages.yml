name: Publish upstream FPF snapshot

on:
  repository_dispatch:
    types:
      - ailev-fpf-main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout wiki
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Fetch latest ailev/FPF main commit
        id: upstream
        run: |
          set -euo pipefail

          url="https://api.github.com/repos/ailev/FPF/commits/main"
          auth_header=()
          if [ -n "${GITHUB_TOKEN:-}" ]; then
            auth_header=(-H "Authorization: Bearer ${GITHUB_TOKEN}")
          fi

          response="$(curl -fsSL "${auth_header[@]}" \
            -H "User-Agent: venikman-fpf-wiki" \
            -H "Accept: application/vnd.github+json" \
            "$url" || true)"

          if [ -z "$response" ]; then
            echo "::error::Failed to fetch upstream commit (empty response)"
            exit 1
          fi

          sha="$(printf '%s' "$response" | jq -r '.sha // empty')"
          author="$(printf '%s' "$response" | jq -r '.commit.author.name // empty')"
          date="$(printf '%s' "$response" | jq -r '.commit.author.date // empty')"
          html_url="$(printf '%s' "$response" | jq -r '.html_url // empty')"
          message="$(printf '%s' "$response" | jq -r '.commit.message // empty')"
          fetched_at="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          if [ -z "$sha" ]; then
            echo "::error::Failed to parse upstream commit (missing sha)"
            exit 1
          fi

          delimiter="EOF_COMMIT_MESSAGE"
          {
            echo "sha=$sha"
            echo "author=$author"
            echo "date=$date"
            echo "html_url=$html_url"
            echo "fetched_at=$fetched_at"
            echo "message<<$delimiter"
            printf "%s\n" "$message"
            echo "$delimiter"
          } >> "$GITHUB_OUTPUT"
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Build static snapshot page
        run: |
          bun -e "
            import { mkdirSync, writeFileSync } from 'node:fs';
            import { join } from 'node:path';
            import { env } from 'bun';

            const site = 'site';
            mkdirSync(site, { recursive: true });

            const {
              SHA,
              MESSAGE,
              AUTHOR = '',
              DATE = '',
              HTML_URL = '',
              FETCHED_AT = '',
              TRIGGER = 'unknown',
            } = env;

            const escapeHtml = (value = '') =>
              String(value).replace(/[&<>'\"]/g, (char) => {
                switch (char) {
                  case '&':
                    return '&amp;';
                  case '<':
                    return '&lt;';
                  case '>':
                    return '&gt;';
                  case '\"':
                    return '&quot;';
                  case \"'\":
                    return '&#x27;';
                  default:
                    return char;
                }
              });

            const content = `<!doctype html>
          <html lang=\"en\">
          <head>
            <meta charset=\"utf-8\">
            <title>FPF upstream snapshot</title>
            <style>
              body { font-family: system-ui, -apple-system, sans-serif; max-width: 760px; margin: 2rem auto; padding: 0 1rem; line-height: 1.6; }
              code { background: #f4f4f4; padding: 0.15rem 0.35rem; border-radius: 4px; }
              pre { background: #f4f4f4; padding: 1rem; border-radius: 6px; white-space: pre-wrap; }
              .meta { color: #444; }
            </style>
          </head>
          <body>
            <h1>Latest ailev/FPF main commit</h1>
            <p class=\"meta\">Generated at ${escapeHtml(FETCHED_AT)} via ${escapeHtml(TRIGGER)}.</p>
            <ul>
              <li><strong>SHA:</strong> <code>${escapeHtml(SHA)}</code></li>
              <li><strong>Author:</strong> ${escapeHtml(AUTHOR)}</li>
              <li><strong>Date:</strong> ${escapeHtml(DATE)}</li>
              <li><strong>Commit:</strong> <a href=\"${escapeHtml(HTML_URL)}\">${escapeHtml(HTML_URL)}</a></li>
            </ul>
            <h2>Message</h2>
            <pre>${escapeHtml(MESSAGE)}</pre>
          </body>
          </html>`;

            writeFileSync(join(site, 'index.html'), content, 'utf8');
          "
        env:
          SHA: ${{ steps.upstream.outputs.sha }}
          MESSAGE: ${{ steps.upstream.outputs.message }}
          AUTHOR: ${{ steps.upstream.outputs.author }}
          DATE: ${{ steps.upstream.outputs.date }}
          HTML_URL: ${{ steps.upstream.outputs.html_url }}
          FETCHED_AT: ${{ steps.upstream.outputs.fetched_at }}
          TRIGGER: ${{ github.event_name }}

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
